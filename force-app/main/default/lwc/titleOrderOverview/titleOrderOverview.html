<template>
  <template if:true={isLoading}>
    <lightning-spinner
      alternative-text="Loading"
      size="small"
    ></lightning-spinner>
  </template>

  <lightning-card if:false={isLoading}>
    
    <lightning-button-group class="slds-p-horizontal_small" slot="actions">
      <lightning-button
        label="Quote Request"
        value="Quote Request"
        onclick={handleClick}
        disabled={disableQuoteRequest}
      ></lightning-button>
      <lightning-button
        label="Order Inquiry"
        value="Order Inquiry"
        disabled={hasNoRequest}
        onclick={handleClick}
      ></lightning-button>
      <lightning-button
        label="Cancel Request"
        value="Cancel Request"
        disabled={hasNoRequest}
        onclick={handleClick}
      ></lightning-button>
      <lightning-button
        label="Quote Accepted"
        value="Quote Accepted"
        disabled={hasNoRequest}
        onclick={handleClick}
      ></lightning-button>
      <lightning-button-menu
        alternative-text="Show menu"
        variant="border-filled"
        onselect={handleClick}
      >
        <lightning-menu-item
          label="Loan Portfolio Change Request"
          value="Loan Portfolio Change Request"
          disabled={hasNoRequest}
        ></lightning-menu-item>
        <lightning-menu-item
          label="Order Change Request"
          value="Order Change Request"
          disabled={titleOrderParams.hasNoOrderNumber}
        ></lightning-menu-item>
        <lightning-menu-item
          label="Document Submission"
          value="Document Submission"
          disabled={hasNoRequest}
        ></lightning-menu-item>
      </lightning-button-menu>
    </lightning-button-group>
    <div class="slds-p-horizontal_small">
      <div class="slds-box" style="text-align: center">
        <h3>
          This loan's current title order status is:&nbsp;
          <strong><span style="color: green">{titleOrderStatus}</span></strong>
        </h3>
      </div>
      <div class="slds-box" style="text-align: center">
        <h3>
          Next step:&nbsp;
          <strong><span style="color: blue">{nextStep}</span></strong>
        </h3>
      </div>
    </div>
  </lightning-card>
  <c-modal title={selectedRequest}>
    <div slot="body">
      <lightning-progress-indicator
        current-step={currStep}
        type="path"
        variant="base"
      >
        <lightning-progress-step
          label="Request Form"
          value="1"
        ></lightning-progress-step>
        <lightning-progress-step
          label="Document Attachment"
          value="2"
        ></lightning-progress-step>
        <lightning-progress-step
          label="Review"
          value="3"
        ></lightning-progress-step>
      </lightning-progress-indicator>
      <template if:false={isLoading}>
        <lightning-card>
          <template if:true={isFormStep}>
            <lightning-record-edit-form
              record-id={recordId}
              object-api-name="Opportunity"
            >
              <lightning-layout multiple-rows="true">
                <template for:each={currForm} for:item="c" for:index="idx">
                  <lightning-layout-item
                    key={key}
                    size={c.size}
                    class="slds-p-around-small"
                  >
                    <template if:true={c.isPropertySelection}>
                      <lightning-combobox
                        name="propertyselection"
                        label="Select a Property"
                        value={selectedToId}
                        placeholder="Select Property"
                        options={titleOrderSelections}
                        onchange={handlePropertySelection}
                        data-type="requestForm"
                        required
                      ></lightning-combobox>
                    </template>
                    <template if:false={c.isPropertySelection}>
                      <template if:true={c.isDealField}>
                        <lightning-input-field
                          field-name={c.fieldName}
                          disabled={c.disabled}
                          data-name={c.dataName}
                          onchange={handleChange}
                          data-type="requestForm"
                          required={c.required}
                        ></lightning-input-field>
                      </template>
                      <template if:false={c.isDealField}>
                        <template if:true={c.isComments}>
                          <lightning-textarea
                            label={c.label}
                            disabled={c.disabled}
                            data-name={c.dataName}
                            value={c.value}
                            onchange={handleChange}
                            data-type="requestForm"
                            required={c.required}
                            variant="label-inline"
                          ></lightning-textarea>
                        </template>
                        <template if:false={c.isComments}>
                          <template if:true={c.isCombobox}>
                            <lightning-combobox
                              label={c.label}
                              value={c.value}
                              disabled={c.disabled}
                              data-name={c.dataName}
                              placeholder="Make a Selection"
                              options={c.options}
                              onchange={handleChange}
                              data-type="requestForm"
                              required={c.required}
                              variant="label-inline"
                            ></lightning-combobox>
                          </template>
                          <template if:false={c.isCombobox}>
                            <lightning-input
                              type={c.type}
                              label={c.label}
                              value={c.value}
                              disabled={c.disabled}
                              data-name={c.dataName}
                              onchange={handleChange}
                              data-type="requestForm"
                              required={c.required}
                              variant="label-inline"
                              formatter={c.formatter}
                              step={c.step}
                            ></lightning-input>
                          </template>
                        </template>
                      </template>
                    </template>
                  </lightning-layout-item>
                </template>
              </lightning-layout>
            </lightning-record-edit-form>
          </template>
          <template if:true={isDocStep}>
            <lightning-layout
              vertical-align="center"
              class="slds-p-around-medium"
            >
              <template if:true={acceptedFormats.length}>
                <lightning-layout-item
                  flexibility="auto"
                  padding="around-small"
                  if:true={excelConfig}
                >
                  <lightning-button
                    label="Generate Document"
                    variant="brand"
                    onclick={handleModalClick}
                  ></lightning-button>
                  <br />
                  <template if:true={docAttributes}>
                    The generated file has also been downloaded. Please review
                    the file before moving forward. If you have to make edits,
                    please do so and then re-upload the file.
                  </template>
                </lightning-layout-item>
                <lightning-layout-item
                  flexibility="auto"
                  padding="around-small"
                  if:true={excelConfig}
                >
                  OR
                </lightning-layout-item>
                <lightning-layout-item
                  flexibility="auto"
                  padding="around-small"
                >
                  <lightning-file-upload
                    label="Upload a file"
                    name="fileUploader"
                    accept={acceptedFormats}
                    onuploadfinished={handleUploadFinished}
                    multiple="false"
                  >
                  </lightning-file-upload>
                </lightning-layout-item>
              </template>
              <template if:false={acceptedFormats.length}>
                <lightning-layout-item
                  flexibility="auto"
                  padding="around-small"
                >
                  This request does not allow document attachments. Please use
                  "Document Submission" if you need to submit any additional
                  file.
                </lightning-layout-item>
              </template>
            </lightning-layout>
          </template>
          <template if:true={isPreviewStep}>
            <lightning-layout
              vertical-align="center"
              class="slds-p-around-medium"
            >
              <lightning-layout-item flexibility="auto" padding="around-small" if:true={downloadLink}>
                <lightning-input
                  label="File"
                  type="text"
                  value={docAttributes.fileName}
                  disabled="true"
                ></lightning-input>
                <p>
                  <lightning-formatted-url
                    value={downloadLink}
                    tooltip={downloadLink}
                    label="Download File"
                    target="_blank"
                  ></lightning-formatted-url>
                </p>
              </lightning-layout-item>
            </lightning-layout>
          </template>
        </lightning-card>
      </template>
      
    </div>
    <div slot="footer">
      <template if:true={showPrev}>
        <lightning-button
          label="Previous"
          variant="brand"
          onclick={handleModalClick}
        ></lightning-button>
      </template>
      <template if:true={showNext}>
        <lightning-button
          label="Next"
          variant="brand"
          onclick={handleModalClick}
          disabled={disableNext}
        ></lightning-button>
      </template>
      <template if:true={showSave}>
        <lightning-button
          label="Submit"
          variant="brand"
          onclick={handleModalClick}
        ></lightning-button>
      </template>

      <lightning-button
        label="Close"
        onclick={handleModalClick}
      ></lightning-button>
    </div>
  </c-modal>
  <template if:true={excelConfig}>
    <c-excel-generator
      file-name={excelFileName}
      row-config={excelConfig}
      query-string={excelQueryString}
      ongenerate={handleDocumentGeneration}
    ></c-excel-generator>
  </template>
</template>